---
title: "scRNA-seq of cells from metabolite-treated mouse intenstine organoids"
subtitle: "Pathway analysis figures"
author: "Paul Heinrich"
output: 
    html_document:
        toc: true
        toc_float: true
        toc_collapsed: true
        toc_depth: 3
---

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup2,echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
#rbioc_3-14
library(rprojroot)
library(yaml)
library(knitr)

saveData <- TRUE

root_criterion <- ".projroot"
proot <- rprojroot::has_file(root_criterion)

source(proot$find_file("experiments/scRNA/analysis/custom/functions/custom_functions.R"))

params <- list()
params$config <- proot$find_file("experiments/scRNA/analysis/custom/hep62703_2023-03-24_A_harmony/config.yaml")
params$analparams <- proot$find_file("experiments/scRNA/analysis/custom/hep62703_2023-03-24_A_harmony/analparams_preprocessing_filters_2023-03-24.yaml")
params$date <- Sys.Date()

config <- yaml.load_file(proot$find_file(params$config))
today <- params$date

config <- yaml.load_file(proot$find_file(params$config))
analparams <- yaml.load_file(proot$find_file(params$analparams))

# libraries
libload <- c(
    "Seurat","ggplot2", "harmony", "Nebulosa", "future",
    "WriteXLS", "knitr", "stringr", "tidyr", "dplyr", "pheatmap",
    "RColorBrewer"
)

for(i in libload) {
    library(i, character.only = T)
}

plan("multicore", workers = 6)
plan()

set.seed(7)
```

```{r loaddata,eval=T,echo=F}

fgseaResults <- readRDS(proot$find_file(
    config$outputpath, "data", "gsea_Stem-TA_wilcox_monocle_Stem-TA_ref_regress-cc_2024-04-24.rds"
))
pathwaySelection <- read.csv(
    proot$find_file(config$outputpath, "metadata", "pathway_selection_2024-04-14.csv")
)

```

```{r prepare_pathway_data, eval=T, echo=F, results='asis'}

fgseaResultsCombined <- data.frame()

for (comparison in names(fgseaResults)) {
    currTable <- fgseaResults[[comparison]]
    currTable[["comparison"]] <- comparison

    fgseaResultsCombined <- rbind(fgseaResultsCombined, currTable)
}

rownames(pathwaySelection) <- pathwaySelection$gene_set_id
pathwaySelection$biological_process <- factor(
    pathwaySelection$biological_process,
    levels = unique(pathwaySelection$biological_process)
)

relevantComparisons <- names(fgseaResults)
comparisonLabels <- relevantComparisons
names(comparisonLabels) <- relevantComparisons

fgseaResultsCombinedSelection <- fgseaResultsCombined %>%
    filter(pathway %in% pathwaySelection$gene_set_id) %>%
    filter(comparison %in% relevantComparisons) %>%
    inner_join(pathwaySelection, by = c("pathway" = "gene_set_id")) %>%
    mutate(pathway = factor(pathway, levels = unique(pathwaySelection$gene_set_id))) %>%
    select(!c("log2err", "leadingEdge", "ES")) %>%
    mutate(neg_log10_padj_signed = (-1)*log10(padj_fdr)*sign(NES)) %>%
    mutate(biological_process = factor(
            biological_process, levels = unique(pathwaySelection$biological_process)
    ))

fgseaResultsCombinedSelection <- fgseaResultsCombinedSelection %>%
    mutate(comparison = factor(
        fgseaResultsCombinedSelection$comparison,
        levels = relevantComparisons
    )) %>%
    arrange(comparison, biological_process, pathway)

```

# Heatmap of adjusted p-values of pathway gene set enrichment

The color of the heatmap dots represents the negative log10 of the FDR-adjusted p-values, multiplied by
+1 or -1 depending the direction of the regulation (downregulation is negative,
upregulation is positive). The scale of signed log10 p-values has been cut at -3 and 3 to be able
to better depict p-values falling into that range. The size of the dots corresponds to the GSEA NES.

```{r heatmap_ggplot_dots, eval=T, echo=F, results='asis', fig.dim=c(8, 12)}

labels <- ggplot(
    fgseaResultsCombinedSelection,
    aes(x = 1, y = pathway, fill = biological_process)
) + geom_tile() +
scale_y_discrete(limits = rev) +
labs(fill = "Biological process") +
theme(
    legend.position = "left",
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank()
)

dotHeatmapPval <- ggplot(
    fgseaResultsCombinedSelection,
    aes(x = comparison, y = pathway, color = neg_log10_padj_signed, size = abs(NES))
) + geom_point() +
scale_color_distiller(palette = "RdBu", limits = c(-3, 3), oob = scales::squish) +
scale_size(range = c(1, 14), limits = c(0.5, 3), breaks = c(1, 1.5, 2, 2.5)) +
scale_y_discrete(limits = rev) +
scale_x_discrete(
    breaks = relevantComparisons,
    labels = comparisonLabels,
    guide = guide_axis(angle = 45)
) +
labs(color = "-log10(q), signed", size = "NES, absolute") +
theme_bw() +
theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.border = element_blank()
)

dotHeatmapPvalComb <- labels + dotHeatmapPval + guide_area() + plot_layout(ncol = 3, widths = c(1, 4, 3), guides = "collect")

dotHeatmapPvalComb

```

```{r save_data, eval=saveData, echo=F}

plotPathHeatmaps <- proot$find_file(config$outputpath, "fig", "monocle_Stem-TA_ref_regress-cc", "pathway_heatmaps")

ggsave(
    file.path(plotPathHeatmaps, "pathway_dot_heatmap_Stem-TA-subset-comparison.pdf"),
    dotHeatmapPvalComb,
    width = 12,
    height = 12,
    dpi = 300
)

```

# SessionInfo

```{r sessionInfo}

sessionInfo()

```

